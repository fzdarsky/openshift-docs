// Module included in the following assemblies:
//
// microshift/microshift-embed-into-rpm-ostree.adoc

= Provisioning with support for MicroShift
You can provision a machine using your {op-system-ostree} image using the procedures from the
https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html-single/composing_installing_and_managing_rhel_for_edge_images/index[{op-system-ostree} documentation].

To support MicroShift, you must provision the system so that it meets the following requirements:

. The machine you are provisioning must meet the xref:../microshift_install/microshift-install-rpm.adoc#system-requirements-installing-microshift[system requirements for installing MicroShift].
. The file system must have a logical volume manager (LVM) volume group (VG) with sufficient capacity for the persistent volumes (PVs) of your workload.
. A link:https://console.redhat.com/openshift/install/pull-secret[pull secret] from the Red Hat Hybrid Cloud Console must be present as `/etc/crio/openshift-pull-secret` and have root user-only read/write permissions.
. The firewall must be configured with {product-title} 's xref:microshift-firewall-config#microshift-required-settings[required firewall settings].

If you are using a procedure using a kickstart file like the {op-system-ostree} Installer (.iso) image,
you can update the kickstart file to meet the above requirements.

.Prerequisites

. You have created an {op-system-ostree} Installer (.iso) image containing your {op-system-ostree} commit with {product-title}.
. Create a Kickstart file or use an existing one.
  In the Kickstart file, ensure that you include the details about how to
  create a user and how to fetch and deploy the {op-system-ostree} image
  (see "Additional Resources").

.Procedure

. In the main section of the kickstart file, update the setup of the filesystem such that it contains an LVM volume group called "rhel" with at least 10GB system root, but leaving free space for the LVMS CSI driver to use for storing the data for your workloads.
+
.Example kickstart snippet for configuring the filesystem
[source,terminal]
----
# Partition disk such that it contains an LVM volume group called "rhel" with a
# 10GB+ system root but leaving free space for the LVMS CSI driver for storing data.
#
# For example, a 20GB disk would be partitioned in the following way:
#
# NAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
# sda             8:0    0  20G  0 disk
# ├─sda1          8:1    0 200M  0 part /boot/efi
# ├─sda1          8:1    0 800M  0 part /boot
# └─sda2          8:2    0  19G  0 part
#  └─rhel-root  253:0    0  10G  0 lvm  /sysroot
#
zerombr
clearpart --all --initlabel
part /boot/efi --fstype=efi --size=200
part /boot --fstype=xfs --asprimary --size=800
# Uncomment this line to add a SWAP partition of the recommended size
#part swap --fstype=swap --recommended
part pv.01 --grow
volgroup rhel pv.01
logvol / --vgname=rhel --fstype=xfs --size=10000 --name=root
----

. In the `%post` section of the kickstart file, add your pull secret and the mandatory firewall rules.
+
.Example kickstart snippet for adding the pull secret and firewall rules
[source,terminal]
----
%post --log=/var/log/anaconda/post-install.log --erroronfail

# Add the pull secret to CRI-O and set root user-only read/write permissions
cat > /etc/crio/openshift-pull-secret << EOF
YOUR_OPENSHIFT_PULL_SECRET_HERE
EOF
chmod 600 /etc/crio/openshift-pull-secret

# Configure the firewall with the mandatory rules for MicroShift
firewall-offline-cmd --zone=trusted --add-source=10.42.0.0/16
firewall-offline-cmd --zone=trusted --add-source=169.254.169.1

%end
----

. Install the `mkksiso` tool by running the following command:
+
[source,terminal]
----
$ sudo yum install -y lorax
----

. Update the kickstart file in the .iso with your new kickstart file:
+
[source,terminal]
----
$ sudo mkksiso your_kickstart.ks your_installer.iso updated_installer.iso
----

[role="_additional-resources"]
.Additional resources
* link:https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/performing_an_advanced_rhel_8_installation/creating-kickstart-files_installing-rhel-as-an-experienced-user[Creating a kickstart file]
* link:https://access.redhat.com/solutions/60959[How to embed a Kickstart file into an ISO image]